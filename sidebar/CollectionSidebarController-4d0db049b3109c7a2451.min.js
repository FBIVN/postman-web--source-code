(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{9737:function(t,e,i){"use strict";i.r(e),function(t){i.d(e,"default",(function(){return f}));var s,r,o=i(1506),n=i(3295),a=i(3735),d=i(7949),c=i(4220),l=i(4216),u=i(8753),b=i(8760),h=i(9738),p=i(4769),m=i(3761),g=i(3781);function S(t,e,i,s,r){var o={};return Object.keys(s).forEach((function(t){o[t]=s[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,s){return s(t,e,i)||i}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}let f=(r=S((s=class{constructor(){var t,e,i,s;this.model=null,this._adapters=[],t=this,e="status",s=this,(i=r)&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(s):void 0})}async didCreate(){if(this.model=new d.default,"browser"===window.SDK_PLATFORM){try{await this._loadFromListingAPIAdapter()}catch(t){return pm.logger.error("CollectionSidebarController~didCreate: Error in loading collection list from listing API",t),this.setSidebarStatus(p.ERROR)}return this.setSidebarStatus(p.READY)}try{await this._loadFromListingAPI(),this.setSidebarStatus(p.READY)}catch(t){pm.logger.error("CollectionSidebarController~didCreate: Failed to fetch collection list:",t)}try{await this._loadFromModelEventsAdapter()}catch(t){return pm.logger.error("CollectionSidebarController~didCreate: Error in loading collections from model events",t),this.setSidebarStatus(p.ERROR)}return this.setSidebarStatus(p.READY)}beforeDestroy(){this._adapters&&this._adapters.forEach(e=>{t.isFunction(e.dispose)&&e.dispose()}),this.model=null,this._adapters=[]}setSidebarStatus(t){this.status=t}async _fetchCollections(){await Object(n.getStore)("SyncStatusStore").onSyncAvailable();const e=Object(n.getStore)("ActiveWorkspaceStore").id,i=await m.RemoteSyncRequestService.request(g.COLLECTION_LIST`${e}`,{method:"POST",timeout:3e4}),s=t.forEach(t.get(i,"body.data",[]),e=>{const i={model:"collection",modelId:e.id,action:"UPDATE_COLLECTION"},s=a.default.getCompositeKey(i);!Object(n.getStore)("PermissionStore").members.has(s)&&t.set(e,"attributes.permissions.userCanUpdate",!0)});return this.model.hydrate&&this.model.hydrate(s),s}async _loadFromListingAPI(){if(pm.isScratchpad)return;!function(e){if(t.isEmpty(e))return;const i=[],s=[],r=[],o=[];e.forEach(e=>{const n=t.get(e,"attributes.flags.isFavorite"),a=t.get(e,"attributes.permissions.teamCanView"),d=t.get(e,"attributes.permissions.anybodyCanView"),c=t.get(e,"attributes.flags.isArchived"),l=Object(m.decomposeUID)(e.id).modelId,u={id:l};n&&i.push(u),a&&s.push(u),d&&r.push({id:e.id}),c&&o.push({model:"collection",modelId:l})}),!t.isEmpty(i)&&Object(n.getStore)("FavoritedCollectionStore").add(i),!t.isEmpty(s)&&Object(n.getStore)("SharedCollectionsStore").add(s),!t.isEmpty(r)&&Object(n.getStore)("PublicEntityStore").add(r),!t.isEmpty(o)&&Object(n.getStore)("ArchivedResourceStore").add(o)}(await this._fetchCollections())}async _loadFromModelEventsAdapter(){const t=Object(n.getStore)("ActiveWorkspaceStore").id,e=new c.default(this.model.getCollectionAdapterModel(),{activeWorkspace:t,useUID:!0}),i=new l.default(this.model.getFolderAdapterModel()),s=new u.default(this.model.getRequestAdapterModel()),r=[e.hydrate(),i.hydrate(),s.hydrate()];this._adapters.push(e,i,s),await Promise.all(r),this.setSidebarStatus(p.READY);const o=new b.default(this.model.getResponseAdapterModel());this._adapters.push(o),await o.hydrate()}async _loadFromListingAPIAdapter(){const t=new h.default(this.model.getCollectionAdapterModel());this._adapters.push(t),await t.hydrate()}}).prototype,"status",[o.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p.LOADING}}),S(s.prototype,"setSidebarStatus",[o.action],Object.getOwnPropertyDescriptor(s.prototype,"setSidebarStatus"),s.prototype),s)}.call(this,i(1133))},9738:function(t,e,i){"use strict";i.r(e),function(t){i.d(e,"default",(function(){return d}));var s=i(3295),r=i(3305),o=i(3310),n=i(3781),a=i(9739);class d extends a.default{getListAndSubscribeAPIEndpoint(){const t=Object(s.getStore)("ActiveWorkspaceStore").id;return n.COLLECTION_LIST_AND_SUBSCRIBE`${t}`}getListAPIEndpoint(){const t=Object(s.getStore)("ActiveWorkspaceStore").id;return n.COLLECTION_LIST`${t}`}dispose(){super.dispose(),this.unsubscribeModelEvents&&this.unsubscribeModelEvents()}_subscribeToChangeEvents(e){super._subscribeToChangeEvents(e),this.unsubscribeModelEvents&&this.unsubscribeModelEvents(),this.unsubscribeModelEvents=null,this.unsubscribeModelEvents=pm.eventBus.channel("model-events").subscribe(e=>{if("collection"!==Object(r.getEventNamespace)(e))return;const i=Object(r.getEventName)(e);if(!["favorite","unfavorite"].includes(i))return;const s=Object(r.getEventData)(e),n=t.get(s,"collection.id"),a=t.get(s,"collection.owner"),d=Object(o.composeUID)(n,a),c="favorite"===i;this.model.updateFavorite&&this.model.updateFavorite(d,c)})}}}.call(this,i(1133))},9739:function(t,e,i){"use strict";i.r(e),function(t){i.d(e,"default",(function(){return d}));var s=i(3507),r=i(3460),o=i(9740),n=i(3295),a=i(4218);class d extends a.default{getListAndSubscribeAPIEndpoint(){throw new Error(this.constructor.name+"~getListAndSubscribeAPIEndpoint: not implemented")}getListAPIEndpoint(){throw new Error(this.constructor.name+"~getListAPIEndpoint: not implemented")}hydrate(e=!0){return new Promise((i,r)=>{this._connection_subscription=Object(s.getSocketConnectionObservable)().subscribe(s=>{if("connect"===s)return this._getAPIResponse().then(i=>{const s=t.get(i,"body.data",[]),r=t.get(i,"body.subscription.id");this._hydrateEntities(s),e&&r&&this._subscribeToChangeEvents(r)}).then(()=>i()).catch(t=>(pm.logger.warn("ListingAPIAdapter~hydrate: Failed to hydrate entities",t),r(t)))})})}dispose(){super.dispose(),this._connection_subscription&&this._connection_subscription.unsubscribe(),this._realtime_subscription&&this._realtime_subscription.unsubscribe()}_hydrateEntities(t){this.model.hydrate&&this.model.hydrate(t)}_removeEntities(e){t.isEmpty(e)||this.model.remove&&this.model.remove(e)}_addEntities(e){t.isEmpty(e)||this.model.add&&this.model.add(e)}async _getAPIResponse(){return await Object(n.getStore)("SyncStatusStore").onSyncAvailable(),r.default.request(this.getListAndSubscribeAPIEndpoint(),{method:"POST",timeout:3e4})}_subscribeToChangeEvents(e){this._realtime_subscription&&this._realtime_subscription.unsubscribe(),this._realtime_subscription=Object(o.realtimeEventsForSubscription)(e).subscribe(e=>{const i=t.get(e,"data.data",[]),s=i.filter(({action:t})=>["create","update"].includes(t)).map(({id:t})=>t),r=i.filter(({action:t})=>"delete"===t).map(({id:t})=>t);this._removeEntities(r),this._createOrUpdateEntities(s)})}async _createOrUpdateEntities(e){if(t.isEmpty(e))return;await Object(n.getStore)("SyncStatusStore").onSyncAvailable();const i=await r.default.request(this.getListAPIEndpoint(),{method:"POST",data:{ids:e},timeout:3e4}),s=t.get(i,"body.data",[]);this._addEntities(s)}}}.call(this,i(1133))},9740:function(t,e,i){"use strict";i.r(e),function(t){i.d(e,"realtimeEventsForSubscription",(function(){return o}));var s=i(3537),r=i(3639);function o(e){return Object(r.getRealtimeMessagesObservable)().pipe(Object(s.filter)(i=>t.get(i,"data.subscription.id")===e))}}.call(this,i(1133))}}]);
//# sourceMappingURL=CollectionSidebarController-4d0db049b3109c7a2451.min.js.map